<section class="mx-auto max-w-2xl">
  <div
    class="rounded-2xl border border-gray-100 bg-white p-8 shadow-lg dark:border-neutral-800 dark:bg-slate-800 md:p-10"
  >
    <form id="contactForm" class="space-y-6" novalidate>
      <div class="grid gap-6 md:grid-cols-2">
        <div class="flex flex-col">
          <label
            for="name"
            class="mb-2 text-sm font-medium text-gray-900 dark:text-white"
            >Nombre *</label
          >
          <input
            type="text"
            id="name"
            name="name"
            placeholder="Ej. Juan Pérez"
            required
            minlength="3"
            class="contact-input rounded-lg border border-gray-300 bg-transparent p-3 text-gray-900 outline-none transition-all focus:ring-2 focus:ring-blue-500 dark:border-neutral-700 dark:text-white"
          />
          <span class="error-msg mt-1 hidden text-[11px] text-red-500"
            >Este campo es obligatorio.</span
          >
        </div>
        <div class="flex flex-col">
          <label
            for="email"
            class="mb-2 text-sm font-medium text-gray-900 dark:text-white"
            >Email *</label
          >
          <input
            type="email"
            id="email"
            name="email"
            placeholder="correo@ejemplo.com"
            required
            class="contact-input rounded-lg border border-gray-300 bg-transparent p-3 text-gray-900 outline-none transition-all focus:ring-2 focus:ring-blue-500 dark:border-neutral-700 dark:text-white"
          />
          <span class="error-msg mt-1 hidden text-[11px] text-red-500"
            >Email no válido.</span
          >
        </div>
      </div>

      <div class="flex flex-col">
        <label
          for="subject"
          class="mb-2 text-sm font-medium text-gray-900 dark:text-white"
          >Asunto *</label
        >
        <input
          type="text"
          id="subject"
          name="subject"
          placeholder="¿En qué puedo ayudarte?"
          required
          class="contact-input rounded-lg border border-gray-300 bg-transparent p-3 text-gray-900 outline-none transition-all focus:ring-2 focus:ring-blue-500 dark:border-neutral-700 dark:text-white"
        />
        <span class="error-msg mt-1 hidden text-[11px] text-red-500"
          >El asunto es obligatorio.</span
        >
      </div>

      <div class="flex flex-col">
        <div class="mb-2 flex items-center justify-between">
          <label
            for="message"
            class="text-sm font-medium text-gray-900 dark:text-white"
            >Mensaje *</label
          >
          <span id="charCounter" class="text-xs text-gray-500">0 / 500</span>
        </div>
        <textarea
          id="message"
          name="message"
          rows="5"
          placeholder="Cuéntame sobre tu proyecto..."
          required
          maxlength="500"
          class="contact-input resize-none rounded-lg border border-gray-300 bg-transparent p-3 text-gray-900 outline-none transition-all focus:ring-2 focus:ring-blue-500 dark:border-neutral-700 dark:text-white"
        ></textarea>
        <span class="error-msg mt-1 hidden text-[11px] text-red-500"
          >El mensaje es obligatorio.</span
        >
      </div>

      <div class="flex justify-center py-2">
        <div class="cf-turnstile" data-sitekey="0x4AAAAAACeyA4VQ96lJ7xmF"></div>
      </div>

      <button
        type="submit"
        id="submitBtn"
        class="flex w-full items-center justify-center rounded-xl bg-blue-600 py-4 font-bold text-white transition-all duration-300 ease-out hover:-translate-y-1 hover:bg-blue-700 hover:shadow-xl hover:shadow-blue-500/30 active:scale-95 disabled:opacity-50"
      >
        <span>Enviar mensaje</span>
      </button>

      <div id="formStatus" class="hidden transition-all duration-300">
        <div id="statusBox" class="flex items-center rounded-xl border p-4">
          <div id="statusIcon" class="mr-3"></div>
          <p id="statusText" class="text-sm font-medium"></p>
        </div>
      </div>
    </form>
  </div>
</section>

<style is:global>
  .border-error {
    border-color: #ef4444 !important;
    background-color: rgba(239, 68, 68, 0.05) !important;
  }
</style>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer
></script>

<script>
  const form = document.getElementById("contactForm") as HTMLFormElement;
  const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
  const inputs = document.querySelectorAll(".contact-input") as NodeListOf<
    HTMLInputElement | HTMLTextAreaElement
  >;
  const formStatus = document.getElementById("formStatus") as HTMLDivElement;
  const statusBox = document.getElementById("statusBox") as HTMLDivElement;
  const statusIcon = document.getElementById("statusIcon") as HTMLDivElement;
  const statusText = document.getElementById(
    "statusText",
  ) as HTMLParagraphElement;
  const charCounter = document.getElementById("charCounter") as HTMLSpanElement;

  function validateInput(input: HTMLInputElement | HTMLTextAreaElement) {
    const errorMsg = input.nextElementSibling as HTMLElement;
    const isValid = input.checkValidity();
    if (!isValid) {
      input.classList.add("border-error");
      errorMsg?.classList.remove("hidden");
    } else {
      input.classList.remove("border-error");
      errorMsg?.classList.add("hidden");
    }
  }

  inputs.forEach((input) => {
    input.addEventListener("blur", () => validateInput(input));
    input.addEventListener("input", () => {
      if (input.id === "message")
        charCounter.textContent = `${input.value.length} / 500`;
    });
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    let isFormValid = true;
    inputs.forEach((input) => {
      validateInput(input);
      if (!input.checkValidity()) isFormValid = false;
    });

    if (!isFormValid) return;

    const token = (window as any).turnstile?.getResponse();
    if (!token) {
      showStatus("Por favor, completa el captcha.", "error");
      return;
    }

    submitBtn.disabled = true;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = "<span>Enviando...</span>";

    const formData = new FormData(form);
    formData.set("cf-turnstile-response", token);

    try {
      const res = await fetch("/api/contact", {
        method: "POST",
        body: formData,
      });

      const result = await res.json();

      if (res.ok) {
        showStatus("¡Mensaje enviado!", "success");
        form.reset();
        (window as any).turnstile?.reset();
      } else {
        showStatus(result.message || "Error al enviar", "error");
      }
    } catch (err) {
      showStatus("Error de red.", "error");
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });

  function showStatus(msg: string, type: "success" | "error") {
    formStatus.classList.remove("hidden");
    statusText.textContent = msg;
    statusIcon.innerHTML = type === "success" ? "✅" : "❌";
    statusBox.className = `flex items-center p-4 rounded-xl border ${
      type === "success"
        ? "border-green-200 bg-green-50 text-green-800"
        : "border-red-200 bg-red-50 text-red-800"
    }`;
  }
</script>
